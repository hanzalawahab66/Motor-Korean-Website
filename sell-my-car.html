<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sell My Car - NSM Autos</title>

  <!-- Tailwind and Fonts (match seller-dashboard.html) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mango: '#D53C46',
            navy: '#1B2951',
            charcoal: '#2D3748',
          },
          fontFamily: {
            heading: ['Inter', 'sans-serif'],
            body: ['Inter', 'sans-serif'],
          },
        },
      },
    };
  </script>
    <!-- Removed external Google Fonts to avoid net::ERR_ABORTED in preview env -->
  <script>window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" rel="stylesheet">
  <!-- Page Protection: seller-only access -->
  <script>
    (function(){
      try {
        var role = (localStorage.getItem('userRole') || localStorage.getItem('role') || '').toLowerCase();
        var token = localStorage.getItem('token');
        if (!token || role !== 'seller') {
          // Redirect non-sellers or unauthenticated users to sign in
 window.open('signin.html', '_blank');
        }
      } catch (e) {
 window.open('signin.html', '_blank');
      }
    })();
  </script>

  <style>
    ::-webkit-scrollbar { display: none; }
    .fade-in-up { animation: fadeInUp .35s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }

    /* Form styles used by Sell My Car form */
    :root{--bg:#f6f7fb;--text:#0f172a;--muted:#64748b;--card:#fff;--border:#e5e7eb;--primary:#2563eb}
    .muted{color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:16px}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .field label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .input,.select,.date,.number{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .checklist{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .check{display:flex;align-items:center;gap:8px;font-size:13px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .btn{padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#fff;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid var(--border);padding:8px;font-size:12px;text-align:left}
    .actions{display:flex;gap:8px;margin-top:16px}
    /* Simple error outline when validation fails */
    .error{outline:2px solid #ef4444; outline-offset:2px}
  </style>
</head>
<body class="font-body bg-gray-50">

  <!-- Header (copied from my-listings.html) -->
  <div class="bg-[#0D1F39] text-white font-body relative z-[60]">
    <div class="container mx-auto px-6 py-2">
      <div class="flex items-center justify-between">
        <div class="relative">
          <button id="languageToggle" class="flex items-center space-x-2 text-white/90 hover:text-white font-medium transition-colors">
            <i class="fa-solid fa-globe text-base"></i>
            <span class="text-sm md:text-base">English</span>
            <i class="fa-solid fa-chevron-down text-xs"></i>
          </button>
          <div id="languageDropdown" class="absolute left-0 top-full mt-1 bg-white rounded-lg shadow-xl border border-gray-200 py-2 min-w-[160px] hidden z-[1000]">
            <button class="w-full px-4 py-2 text-left text-sm md:text-base text-gray-700 hover:bg-gray-50 transition-colors flex items-center space-x-2 font-medium" data-lang="en"><img src="https://flagcdn.com/w20/us.png" alt="English" class="w-4 h-3"><span>English</span></button>
            <button class="w-full px-4 py-2 text-left text-sm md:text-base text-gray-700 hover:bg-gray-50 transition-colors flex items-center space-x-2 font-medium" data-lang="ko"><img src="https://flagcdn.com/w20/kr.png" alt="한국어" class="w-4 h-3"><span>한국어</span></button>
            <button class="w-full px-4 py-2 text-left text-sm md:text-base text-gray-700 hover:bg-gray-50 transition-colors flex items-center space-x-2 font-medium" data-lang="ar"><img src="https://flagcdn.com/w20/sa.png" alt="العربية" class="w-4 h-3"><span>العربية</span></button>
            <button class="w-full px-4 py-2 text-left text-sm md:text-base text-gray-700 hover:bg-gray-50 transition-colors flex items-center space-x-2 font-medium" data-lang="fr"><img src="https://flagcdn.com/w20/fr.png" alt="Français" class="w-4 h-3"><span>Français</span></button>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <button class="bg-white/10 hover:bg-white/20 text-white px-4 py-1.5 rounded-lg font-medium transition-all h-hover" data-text="sign-in" onclick="window.open('signin.html','_blank')">Login</button>
          <button class="bg-[#D53C46] text-white hover:bg-[#D53C46] px-4 py-1.5 rounded-lg font-semibold transition-all h-hover" data-text="sign-up" onclick="window.open('signup.html','_blank')">Register</button>
        </div>
      </div>
    </div>
  </div>

  <header id="header" class="sticky top-0 z-50 backdrop-blur">
  <div class="w-full px-6 py-2 bg-white">
    <div class="w-full px-4 md:px-6 py-3 flex items-center justify-between">
        <a href="home.html" class="flex items-center space-x-3">
          <img src="assets/images/Gemini_Generated_Image_2f4bkg2f4bkg2f4bee.png" alt="Logo" class="w-80 h-[100px] object-contain animate-logo" />
        </a>
        <nav class="hidden md:flex items-center space-x-8 text-gray-900 font-semibold animate-nav">
          <a href="home.html" class="hover:text-[#0D1F39] transition-colors">Home</a>
          <a href="inventory.html" class="hover:text-[#0D1F39] transition-colors">Inventory</a>
          <div class="relative" id="navAbout">
            <a href="about-us.html" id="navAboutToggle" class="hover:text-[#0D1F39] transition-colors flex items-center space-x-1"><span>About Us</span><i class="fa-solid fa-chevron-down text-xs"></i></a>
            <div id="navAboutMenu" class="absolute left-1/2 -translate-x-1/2 mt-2 bg-white border border-gray-200 rounded-xl shadow-lg py-2 min-w-[220px] opacity-0 translate-y-1 pointer-events-none transition-all duration-300 z-50">
              <a href="mit-info.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 hover:text-[#0D1F39] transition-colors">MIT Info</a>
              <a href="service-introduction.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 hover:text-[#0D1F39] transition-colors">Service Introduction</a>
            </div>
          </div>
          <a href="contact-us.html" class="hover:text-[#0D1F39] transition-colors">Contact Us</a>
          <div class="relative" id="navMore">
            <button id="navMoreToggle" class="hover:text-[#0D1F39] transition-colors flex items-center space-x-1"><span>More</span><i class="fa-solid fa-chevron-down text-xs"></i></button>
            <div id="navMoreMenu" class="absolute left-1/2 -translate-x-1/2 mt-2 bg-white border border-gray-200 rounded-xl shadow-lg py-2 min-w-[220px] opacity-0 translate-y-1 pointer-events-none transition-all duration-300 z-50">
              <a href="faq.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 hover:text-[#0D1F39] transition-colors">FAQs</a>
              <a href="reviews.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 hover:text-[#0D1F39] transition-colors">Reviews</a>
              <a href="blog.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 hover:text-[#0D1F39] transition-colors">Blogs</a>
            </div>
          </div>
        </nav>
        <div class="flex items-center space-x-4 animate-actions">
          <div class="hidden md:flex items-center bg-white rounded-full shadow px-3 py-1.5 border border-gray-200">
            <i class="fa-solid fa-magnifying-glass text-gray-600 mr-2 hover:text-[#D53C46]"></i>
            <input id="headerSearchInput" type="text" placeholder="Search" class="w-40 md:w-52 text-sm bg-transparent focus:outline-none" />
          </div>
          <button id="mobileSearchToggle" class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 transition group h-hover"><i class="fa-solid fa-magnifying-glass group-hover:text-[#D53C46]"></i></button>
          <a id="headerFavorite" href="dashboard-saved.html" class="relative inline-flex items-center justify-center w-10 h-10 rounded-full border border-gray-200 hover:bg-gray-50 transition-colors group h-hover"><i class="fa-regular fa-heart text-[#0D1F39] group-hover:text-[#D53C46]"></i><span class="absolute -top-1 -right-1 inline-flex items-center justify-center w-5 h-5 rounded-full bg-[#D53C46] text-white text-xs">0</span></a>
          <button id="mobileMenuToggle" class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 transition group h-hover"><i class="fa-solid fa-bars group-hover:text-[#D53C46]"></i></button>
        </div>
      </div>
    </div>
  </header>

  <script>
    document.addEventListener('DOMContentLoaded', function(){ var h = document.getElementById('header'); if (h) { requestAnimationFrame(function(){ h.classList.add('header-ready'); }); } });
  </script>
  <script>(function(){function setupHoverDelay(containerId,toggleId,menuId){var c=document.getElementById(containerId);var t=document.getElementById(toggleId);var m=document.getElementById(menuId);if(!c||!t||!m)return;var hid=null;function show(){if(hid){clearTimeout(hid);hid=null;}m.classList.remove('opacity-0','pointer-events-none','translate-y-1');m.classList.add('opacity-100','pointer-events-auto','translate-y-0');}function schedule(){if(hid)clearTimeout(hid);hid=setTimeout(function(){m.classList.remove('opacity-100','pointer-events-auto','translate-y-0');m.classList.add('opacity-0','pointer-events-none','translate-y-1');hid=null;},300);}c.addEventListener('mouseenter',show);t.addEventListener('mouseenter',show);m.addEventListener('mouseenter',show);c.addEventListener('mouseleave',schedule);t.addEventListener('mouseleave',schedule);m.addEventListener('mouseleave',schedule);t.addEventListener('click',show);}setupHoverDelay('navAbout','navAboutToggle','navAboutMenu');setupHoverDelay('navMore','navMoreToggle','navMoreMenu');})();</script>

  <div id="mobileSearchContainer" class="md:hidden hidden px-6">
    <div class="flex items-center bg-white rounded-full shadow px-3 py-2 border border-gray-200">
      <i class="fa-solid fa-magnifying-glass text-gray-600 mr-2"></i>
      <input id="mobileHeaderSearchInput" type="text" placeholder="Search" class="flex-1 text-sm bg-transparent focus:outline-none" />
      <button id="mobileHeaderSearchBtn" class="ml-2 px-3 py-1 rounded-full bg-[#0D1F39] text-white text-xs">Search</button>
    </div>
  </div>

  <div id="mobileMenuOverlay" class="fixed inset-0 bg-black/40 hidden z-40 md:hidden"></div>
  <aside id="mobileDrawer" class="fixed inset-y-0 right-0 w-80 max-w-[88vw] bg-white shadow-xl border-l border-gray-200 z-50 transform translate-x-full transition-transform duration-300 ease-out md:hidden" aria-hidden="true" role="dialog">
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
      <div class="flex items-center space-x-2"><img src="assets/images/Gemini_Generated_Image_2f4bkg2f4bkg2f4bee.png" alt="Logo" class="w-64 h-16 object-contain" /></div>
      <button id="mobileDrawerClose" class="inline-flex items-center justify-center w-10 h-10 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 transition" aria-label="Close menu"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="px-4 py-3">
      <div class="flex items-center bg-white rounded-full border border-gray-200 px-3 py-2 shadow-sm"><i class="fa-solid fa-magnifying-glass text-gray-600 mr-2"></i><input id="drawerSearchInput" type="text" placeholder="Search" class="flex-1 text-sm bg-transparent focus:outline-none" /><button id="drawerSearchBtn" class="ml-2 px-3 py-1 rounded-full bg-[#0D1F39] text-white text-xs">Search</button></div>
    </div>
    <nav class="px-4 py-3 space-y-1 text-gray-900 font-semibold">
      <a href="home.html" class="block py-2 rounded-lg hover:bg-gray-50">Home</a>
      <a href="inventory.html" class="block py-2 rounded-lg hover:bg-gray-50">Inventory</a>
      <div class="border-t border-gray-100 my-2"></div>
      <button id="drawerAboutToggle" class="w-full flex items-center justify-between py-2 rounded-lg hover:bg-gray-50 text-left" aria-expanded="false"><span>About Us</span><i class="fa-solid fa-chevron-down text-xs"></i></button>
      <div id="drawerAboutMenu" class="hidden ml-3 space-y-1 text-gray-700 font-normal"><a href="mit-info.html" class="block py-1.5 rounded hover:bg-gray-50">MIT Info</a><a href="service-introduction.html" class="block py-1.5 rounded hover:bg-gray-50">Service Introduction</a></div>
      <a href="contact-us.html" class="block py-2 rounded-lg hover:bg-gray-50">Contact Us</a>
      <button id="drawerMoreToggle" class="w-full flex items-center justify-between py-2 rounded-lg hover:bg-gray-50 text-left" aria-expanded="false"><span>More</span><i class="fa-solid fa-chevron-down text-xs"></i></button>
      <div id="drawerMoreMenu" class="hidden ml-3 space-y-1 text-gray-700 font-normal"><a href="faq.html" class="block py-1.5 rounded hover:bg-gray-50">FAQs</a><a href="reviews.html" class="block py-1.5 rounded hover:bg-gray-50">Reviews</a><a href="blog.html" class="block py-1.5 rounded hover:bg-gray-50">Blogs</a></div>
    </nav>
  </aside>

  <script>
    (function(){
      var overlay = document.getElementById('mobileMenuOverlay');
      var drawer = document.getElementById('mobileDrawer');
      var menuBtn = document.getElementById('mobileMenuToggle');
      var closeBtn = document.getElementById('mobileDrawerClose');
      function openDrawer(){ if (overlay && drawer) { overlay.classList.remove('hidden'); drawer.style.transform='translateX(0)'; } }
      function closeDrawer(){ if (overlay && drawer) { overlay.classList.add('hidden'); drawer.style.transform=''; } }
      if (menuBtn) menuBtn.addEventListener('click', openDrawer);
      if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
    if (overlay) overlay.addEventListener('click', closeDrawer);
    var drawerAboutToggle = document.getElementById('drawerAboutToggle');
    var drawerAboutMenu = document.getElementById('drawerAboutMenu');
    if (drawerAboutToggle && drawerAboutMenu) {
      drawerAboutToggle.addEventListener('click', function(){
        var hidden = drawerAboutMenu.classList.toggle('hidden');
        drawerAboutToggle.setAttribute('aria-expanded', hidden ? 'false' : 'true');
      });
    }
    var drawerMoreToggle = document.getElementById('drawerMoreToggle');
    var drawerMoreMenu = document.getElementById('drawerMoreMenu');
    if (drawerMoreToggle && drawerMoreMenu) {
      drawerMoreToggle.addEventListener('click', function(){
        var hidden = drawerMoreMenu.classList.toggle('hidden');
        drawerMoreToggle.setAttribute('aria-expanded', hidden ? 'false' : 'true');
      });
    }
    })();
  </script>

  <!-- Main: Sell My Car form -->
  <main class="container mx-auto px-6 py-10">
    <section class="bg-white rounded-2xl shadow-lg p-8 flex items-center justify-between fade-in-up">
      <div>
        <h1 class="text-2xl md:text-3xl font-heading font-bold text-navy">Sell My Car</h1>
        <p class="text-gray-600 mt-2">Create a new listing with photos, details, and price.</p>
      </div>
      <div class="hidden md:flex items-center space-x-4">
        <span class="px-3 py-1 rounded-full bg-red-100 text-red-600 text-sm font-medium">Seller</span>
      </div>
    </section>

    <!-- Sell My Car Form -->
    <section class="mt-8">
      <h2 class="sr-only">Sell My Car Form</h2>
      <p class="muted">Add a new vehicle with categorization, specs, features, and insurance history.</p>

      <!-- Listing Basics -->
      <section class="card">
        <h2>Listing Basics</h2>
        <div class="grid grid-2">
          <div class="field">
            <label>Listing Title</label>
            <input id="listing-title" class="input" placeholder="e.g. 2018 Toyota Corolla SE" required />
          </div>
          <div class="field">
            <label>Price</label>
            <input id="listing-price" type="number" step="0.01" class="number" placeholder="e.g. 15999" required />
          </div>
        </div>
        <div class="grid grid-2" style="margin-top:12px">
          <div class="field">
            <label>Product Identification Number (PIN)</label>
            <input id="product-id-number" class="input" placeholder="e.g. PIN-12345" required />
          </div>
        </div>
      </section>

      <!-- 1) Categorization -->
      <section class="card">
        <h2>1) Categorization</h2>
        <div class="grid grid-2">
          <div class="field">
            <label>Category</label>
            <select id="category-id" class="select" aria-label="Select Category" required>
              <option value="">— Loading categories —</option>
            </select>
            <span class="muted">Only categories from the list can be selected.</span>
          </div>
          <div class="field">
            <label>Tags</label>
            <div id="tag-list" class="checklist"></div>
            <span class="muted">Select applicable tags for this listing.</span>
          </div>
        </div>
      </section>

      <!-- 2) Vehicle Info -->
      <section class="card">
        <h2>2) Vehicle Info</h2>
        <div class="grid grid-3">
          <div class="field"><label>Year</label><input type="number" min="1950" max="2100" class="number" id="v-year" required></div>
          <div class="field"><label>Model</label><select class="select" id="v-model" required><option value="">— Loading models —</option></select></div>
          <div class="field"><label>Transmission</label><select class="select" id="v-trans" required><option>Automatic</option><option>Manual</option><option>CVT</option></select></div>
          <div class="field"><label>Fuel</label><select class="select" id="v-fuel" required><option>Gasoline</option><option>Diesel</option><option>Hybrid</option><option>Electric</option></select></div>
          <div class="field"><label>Color</label><input class="input" id="v-color" placeholder="e.g. White" required></div>
          <div class="field"><label>Displacement (L)</label><input type="number" step="0.1" class="number" id="v-displ" required></div>
          <div class="field"><label>Passenger Capacity</label><input type="number" min="1" class="number" id="v-pass" required></div>
          <div class="field"><label>Drive Type</label><select class="select" id="v-drive" required><option>FWD</option><option>RWD</option><option>AWD</option><option>4WD</option></select></div>
          <div class="field"><label>Chassis Number (Private)</label><input class="input" id="v-chassis" placeholder="e.g. ABC1234567890" required></div>
          <div class="field"><label>First Reg. Date</label><input type="date" class="date" id="v-reg" required></div>
          <div class="field"><label>Mileage (km)</label><input type="number" class="number" id="v-mile" required></div>
          <div class="field"><label>Location</label><input class="input" id="v-loc" placeholder="City, Country" required></div>
        </div>
      </section>

      <!-- 3) Relevant Information -->
      <section class="card">
        <h2>3) Relevant Information</h2>
        <div id="relevant-list" class="checklist"></div>
      </section>

      <!-- 4) Option Info -->
      <section class="card">
        <h2>4) Option Info</h2>
        <div id="options-list" class="checklist"></div>
      </section>

      <!-- 5) Interior/Exterior -->
      <section class="card">
        <h2>5) Interior/Exterior</h2>
        <div id="interior-list" class="checklist"></div>
      </section>

      <!-- 6) Safety -->
      <section class="card">
        <h2>6) Safety</h2>
        <div id="safety-list" class="checklist"></div>
      </section>

      <!-- 7) Convenience / Other -->
      <section class="card">
        <h2>7) Convenience / Other</h2>
        <div id="conv-list" class="checklist"></div>
      </section>

      <!-- 8) Insurance History -->
      <section class="card">
        <h2>8) Insurance History</h2>
        <div class="grid grid-3">
          <div class="field"><label>Manufacturer</label><input class="input" id="ih-mfr" required></div>
          <div class="field"><label>Model</label><input class="input" id="ih-model" required></div>
          <div class="field"><label>Year</label><input type="number" class="number" id="ih-year" required></div>
          <div class="field"><label>Fuel</label><input class="input" id="ih-fuel" required></div>
          <div class="field"><label>License Plate</label><input class="input" id="ih-plate" required></div>
        </div>
        <div style="margin-top:10px">
          <strong>Accident Records</strong>
          <table class="table">
            <thead><tr><th>Repair Cost</th><th>Part</th><th>Labor</th><th>Painting</th><th>Action</th></tr></thead>
            <tbody id="accident-body"></tbody>
          </table>
          <div class="actions"><button id="add-accident" class="btn">Add Record</button></div>
        </div>
      </section>

      <!-- 9) Upload Photos -->
      <section class="card">
        <h2>9) Upload Photos</h2>
        <div class="grid grid-2">
          <div class="field">
            <label>Photos</label>
            <input id="photo-upload" type="file" class="input" accept="image/*" multiple required>
            <div class="muted">You can upload up to 20 photos. Supported: JPG, PNG.</div>
          </div>
          <div class="field">
            <label>Uploaded</label>
            <div id="photo-chips" class="chips"></div>
          </div>
        </div>
      </section>

      <!-- Final Action -->
      <section class="card">
        <div class="actions">
          <button id="submit-approval" class="btn btn-primary">Submit for Approval</button>
        </div>
      </section>
    </section>
  </main>

  <!-- Footer (copied from my-listings.html) -->
  <footer class="bg-white border-t">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-sm text-gray-600 flex items-center justify-between">
      <span>© 2025 NSM Autos</span>
      <div class="space-x-4">
        <a href="about-us.html" class="hover:text-black">About</a>
        <a href="contact-us.html" class="hover:text-black">Contact</a>
      </div>
    </div>
  </footer>

  <!-- Page Script: populate tag/category, upload chips, and submission -->
      <script>
        (function(){
          const API_ORIGIN = (function() {
            try {
              const origin = window.__apiOrigin;
              if (origin && /^https?:\/\//i.test(origin)) return origin.replace(/\/$/, '');
            } catch (_) {
            }
            try {
              return window.location.origin;
            } catch (_) {
              return '';
            }
          })();
          // Category select: attempt backend, fallback to local JSON
          (function(){
            const API = API_ORIGIN;
            const selectEl=document.getElementById('category-id');
            function setLoading(){ if(selectEl) selectEl.innerHTML='<option value="">— Loading categories —</option>'; }
            function setError(msg){ if(selectEl) selectEl.innerHTML='<option value="">'+String(msg||'Failed to load categories')+'</option>'; }
            function buildTreeOptions(cats){
          const byParent=new Map();
          (Array.isArray(cats)?cats:[]).forEach(c=>{
            const key=(c.parent_id==null)?'null':String(c.parent_id);
            if(!byParent.has(key)) byParent.set(key,[]);
            byParent.get(key).push(c);
          });
          for(const list of byParent.values()){ list.sort((a,b)=>String(a.name).localeCompare(String(b.name))); }
          const out=[];
          function walk(parentKey,depth){
            const list=byParent.get(parentKey)||[];
            list.forEach(c=>{ out.push({id:c.id,name:c.name,depth}); walk(String(c.id),depth+1); });
          }
          walk('null',0);
          return out;
        }
        function renderOptions(options){
          const nbsp='\u00A0';
          const indent=(d)=> (d>0? (nbsp.repeat(2*d)+'↳ '):'');
          const html=['<option value="">— Select a category —</option>']
            .concat(options.map(o=>`<option value="${String(o.id)}">${indent(o.depth)}${String(o.name)}</option>`));
          selectEl.innerHTML=html.join('');
        }
        async function load(){
          if(!selectEl) return; setLoading();
          const token=localStorage.getItem('token');
          try{
            const headers = { 'Accept':'application/json' };
            if(token) headers['Authorization'] = `Bearer ${token}`;
            const res=await fetch(`${API}/admin/categories`,{ headers });
            let data = await res.json().catch(()=>null);
            if(!res.ok){ throw new Error((data && data.error) || `HTTP ${res.status}`); }
            const options=buildTreeOptions(data);
            renderOptions(options);
          }catch(err){
            console.warn('Admin categories fetch failed, falling back:',err);
            try{
              const res2 = await fetch('/backend/categories.json', { headers:{ 'Accept':'application/json' } });
              const data2 = await res2.json();
              const options=buildTreeOptions(data2);
              renderOptions(options);
            }catch(e2){ console.error('Fallback categories load failed:', e2); setError('Failed to load categories'); }
          }
        }
        load();
      })();

      // Vehicle models dropdown: fetch from backend, fallback to local JSON
      (function(){
        const API = API_ORIGIN;
        const selectEl=document.getElementById('v-model');
        const ihModelEl=document.getElementById('ih-model');
        if(!selectEl) return;
        function setLoading(){ selectEl.innerHTML='<option value="">— Loading models —</option>'; }
        function setError(msg){ selectEl.innerHTML='<option value="">'+String(msg||'Failed to load models')+'</option>'; }
        function renderOptions(models){
          const list = Array.isArray(models) ? models : [];
          const sorted = list.slice().sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')));
          const html=['<option value="">— Select a model —</option>']
            .concat(sorted.map(m=>`<option value="${String(m.id)}">${String(m.name || m.slug || ('Model '+m.id))}</option>`));
          selectEl.innerHTML=html.join('');
        }
        async function load(){
          setLoading();
          try{
            const res=await fetch(`${API}/public/models`,{ headers:{ 'Accept':'application/json' } });
            let data = await res.json().catch(()=>null);
            if(!res.ok){ throw new Error((data && data.error) || `HTTP ${res.status}`); }
            const models = Array.isArray(data?.models) ? data.models : Array.isArray(data) ? data : [];
            renderOptions(models);
          }catch(err){
            console.warn('Public models fetch failed, falling back:',err);
            try{
              const res2 = await fetch('/backend/models.json',{ headers:{ 'Accept':'application/json' } });
              const data2 = await res2.json();
              renderOptions(data2);
            }catch(e2){ console.error('Fallback models load failed:', e2); setError('Failed to load models'); }
          }
        }
        selectEl.addEventListener('change', function(){
          try{
            const text = selectEl.options[selectEl.selectedIndex]?.text || '';
            if(ihModelEl){ ihModelEl.value = text; }
          }catch(_){}
        });
        load();
      })();

      const items={
        relevant:['Total Loss','Flood Damage','Theft','Government usage'],
        options:['Sunroof','4WD','Leather Seat','Heated Seat','Ventilated Seat','Rear Camera','360° View','Smart Key','Navigation','Auto A/C'],
        interior:['Power Seat','Roof Rack','Heated Seat','Power Steering Wheel','Power Door Lock'],
        safety:['Parking Sensor','All Airbags','ABS'],
        conv:['Cruise Control','AUX','CD Player','Bluetooth','USB']
      };
      function renderChecks(id,arr){
        const el=document.getElementById(id);
        el.innerHTML='';
        arr.forEach(name=>{
          const lab=document.createElement('label');
          lab.className='check';
          const cb=document.createElement('input');
          cb.type='checkbox';
          cb.value=name;
          cb.name=id+'[]';
          lab.appendChild(cb);
          lab.appendChild(document.createTextNode(' '+name));
          el.appendChild(lab);
        });
      }
      renderChecks('relevant-list',items.relevant);
      renderChecks('options-list',items.options);
      renderChecks('interior-list',items.interior);
      renderChecks('safety-list',items.safety);
      renderChecks('conv-list',items.conv);

      // Strict tags: fetch from backend and render as checkboxes
      (function(){
        const container=document.getElementById('tag-list');
        if(!container) return;
        fetch(API_ORIGIN + '/public/tags', { headers: { 'Accept':'application/json' } })
          .then(r=> r.ok ? r.json() : Promise.reject(new Error('Failed to load tags')))
          .then(data => {
            const tags = Array.isArray(data?.tags) ? data.tags : Array.isArray(data) ? data : [];
            container.innerHTML='';
            tags.forEach(tag => {
              const lab=document.createElement('label'); lab.className='check';
              const cb=document.createElement('input'); cb.type='checkbox'; cb.value=String(tag.id); cb.name='tag-list[]';
              lab.appendChild(cb); lab.appendChild(document.createTextNode(' '+(tag.name || tag.slug || ('Tag '+tag.id))));
              container.appendChild(lab);
            });
          })
          .catch(err => {
            container.innerHTML = '<span class="muted">Failed to load tags.</span>';
            console.warn('Tags load error:', err);
          });
      })();

      const tbody=document.getElementById('accident-body');
      document.getElementById('add-accident').onclick=()=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><input type=\"number\" class=\"number\" placeholder=\"Repair\"></td><td><input type=\"number\" class=\"number\" placeholder=\"Part\"></td><td><input type=\"number\" class=\"number\" placeholder=\"Labor\"></td><td><input type=\"number\" class=\"number\" placeholder=\"Painting\"></td><td><button class=\"btn\">Remove</button></td>`;
        tr.querySelector('button').onclick=()=>tr.remove();
        tbody.appendChild(tr);
      };

      // Upload photo chips
      const photoInput = document.getElementById('photo-upload');
      const photoChips = document.getElementById('photo-chips');
      let photos = [];
      // Helper: convert a File to data URL
      async function fileToDataUrl(file){
        return await new Promise((resolve,reject)=>{
          try{
            const reader=new FileReader();
            reader.onload=function(){ resolve(reader.result); };
            reader.onerror=function(e){ reject(e); };
            reader.readAsDataURL(file);
          }catch(e){ reject(e); }
        });
      }
      // Helper: upload a file to backend and return relative url (e.g. "/uploads/xyz.png")
      async function uploadFileToServer(file){
        const dataUrl = await fileToDataUrl(file);
        const resp = await fetch(API_ORIGIN + '/upload',{
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify({ filename: file.name, dataUrl })
        });
        let out=null; try{ out=await resp.json(); }catch(_){ out=null; }
        if(!resp.ok || !out || !out.url){
          const msg = (out && out.error) ? out.error : ('Upload failed (HTTP '+resp.status+')');
          throw new Error(msg);
        }
        return out.url;
      }
      // Render photo chips with thumbnails
      function renderPhotoChips(){
        photoChips.innerHTML='';
        photos.forEach(p=>{
          const chip=document.createElement('span');
          chip.className='btn';
          chip.innerHTML = `<img src="${p.dataUrl}" alt="${p.name}" style="width:44px;height:44px;object-fit:cover;border-radius:6px;margin-right:8px;vertical-align:middle;" /> <span>${p.name}</span>`;
          photoChips.appendChild(chip);
        });
      }
      photoInput.addEventListener('change', async function(){
        const files = Array.from(photoInput.files || []);
        for(const f of files){
          try{
            const relative = await uploadFileToServer(f); // "/uploads/xyz.png"
            const absolute = API_ORIGIN + relative;
            photos.push({ name: f.name, url: relative, dataUrl: absolute });
          }catch(err){
            console.error('Upload error:', err);
            alert('Failed to upload '+f.name+': '+(err && err.message ? err.message : err));
          }
        }
        renderPhotoChips();
      });

      // Submit for approval: POST to backend /submit-listing (seller-only)
      document.getElementById('submit-approval').addEventListener('click', async function(){
        try{
          const API = API_ORIGIN;
          const token = localStorage.getItem('token');
          const headers = { 'Accept':'application/json', 'Content-Type':'application/json' };
          if (token) headers['Authorization'] = 'Bearer ' + token;

          // Client-side validation: require all fields and groups except Accident Records
          const errors=[];
          const photoInputEl = document.getElementById('photo-upload');
          function markError(el){ if(!el) return; el.classList.add('error'); setTimeout(()=>{ try{ el.classList.remove('error'); }catch(_){} }, 3000); }
          function requireValue(id,label){ const el=document.getElementById(id); if(!el){ errors.push(label); return; } const t=(el.type||'').toLowerCase(); let ok=true; if(t==='file'){ ok = !!(el.files && el.files.length>0); } else if(t==='number' || t==='date'){ ok = !!(el.value && String(el.value).trim()!==''); } else { ok = !!(el.value && String(el.value).trim()!==''); } if(!ok){ errors.push(label); markError(el); } }
          function requireGroup(containerId,label){ const cont=document.getElementById(containerId); const checked = cont ? cont.querySelectorAll('input[type="checkbox"]:checked').length : 0; if(checked===0){ errors.push(label); if(cont){ markError(cont); } } }

          // Basics
          requireValue('listing-title','Listing Title');
          requireValue('listing-price','Price');
          requireValue('product-id-number','Product Identification Number');
          // Category
          requireValue('category-id','Category');
          // Vehicle Info
          ['v-year','v-model','v-trans','v-fuel','v-color','v-displ','v-pass','v-drive','v-chassis','v-reg','v-mile','v-loc'].forEach(id=>requireValue(id,'Vehicle Info: '+id.replace('v-','')));
          // Groups
          requireGroup('relevant-list','Relevant Information');
          requireGroup('options-list','Option Info');
          requireGroup('interior-list','Interior/Exterior');
          requireGroup('safety-list','Safety');
          requireGroup('conv-list','Convenience / Other');
          // Tags
          requireGroup('tag-list','Tags');
          // Photos
          requireValue('photo-upload','Photos');

          if(errors.length>0){
            alert('Please complete required fields:\n - '+errors.join('\n - '));
            return;
          }

          // Helpers for building extended payload
          function getChecked(id){
            const el=document.getElementById(id); if(!el) return [];
            return Array.from(el.querySelectorAll('input[type=checkbox]'))
              .filter(cb=>cb.checked)
              .map(cb=>cb.value);
          }
          function getAccidents(){
            const rows=Array.from((document.getElementById('accident-body')||document.createElement('tbody')).querySelectorAll('tr'));
            return rows.map(r=>{
              const cells=r.querySelectorAll('td');
              return {
                repairCost: Number((cells[0]?.querySelector('input')?.value)||0),
                part: (cells[1]?.querySelector('input')?.value)||'',
                labor: Number((cells[2]?.querySelector('input')?.value)||0),
                painting: Number((cells[3]?.querySelector('input')?.value)||0)
              };
            });
          }
          function getVal(id){ const el=document.getElementById(id); return (el && el.value) || ''; }

          // Collect selected tag IDs
          const tagChecked = Array.from(document.querySelectorAll('#tag-list input[type="checkbox"]:checked'))
            .map(cb => Number(cb.value))
            .filter(n => Number.isFinite(n));

          // Payload fields aligned to backend /submit-listing
          const payload = {
            title: document.getElementById('listing-title').value || '',
            price: Number(document.getElementById('listing-price').value || 0),
            product_id_number: document.getElementById('product-id-number').value || '',
            categoryId: (function(){
              const v = document.getElementById('category-id').value;
              const n = Number(v);
              return Number.isFinite(n) && n > 0 ? n : null;
            })(),
            description: null,
            tagIds: tagChecked,
            vehicle:{
              modelId: (function(){ const v=document.getElementById('v-model')?.value; const n=Number(v); return Number.isFinite(n)&&n>0? n : null; })(),
              modelName: (function(){ const sel=document.getElementById('v-model'); const opt = sel && sel.options[sel.selectedIndex]; const t = opt ? opt.textContent.trim() : ''; return t || null; })(),
              year: Number(getVal('v-year')||0),
              transmission: getVal('v-trans'),
              fuel: getVal('v-fuel'),
              color: getVal('v-color'),
              displacementL: Number(getVal('v-displ')||0),
              passengerCapacity: Number(getVal('v-pass')||0),
              driveType: getVal('v-drive'),
              chassisNumber: getVal('v-chassis'),
              firstRegDate: getVal('v-reg'),
              mileageKm: Number(getVal('v-mile')||0),
              location: getVal('v-loc')
            },
            relevant: getChecked('relevant-list'),
            options: getChecked('options-list'),
            interior: getChecked('interior-list'),
            safety: getChecked('safety-list'),
            convenience: getChecked('conv-list'),
            insuranceHistory:{
              manufacturer: getVal('ih-mfr'),
              model: getVal('ih-model'),
              year: Number(getVal('ih-year')||0),
              fuel: getVal('ih-fuel'),
              licensePlate: getVal('ih-plate'),
              accidents: getAccidents()
            },
            photos: (Array.isArray(photos) ? photos.map(p=> ({ name: p.name, dataUrl: p.dataUrl, url: p.url })) : []),
            photoCount: Array.isArray(photos) ? photos.length : 0,
            status: 'pending_approval'
          };

          const res = await fetch(API + '/submit-listing', { method:'POST', headers, body: JSON.stringify(payload) });
          const data = await res.json().catch(()=>null);
          if(!res.ok){ alert((data && data.error) || ('Submit failed (HTTP '+res.status+')')); return; }
          alert('Listing submitted successfully!');
        }catch(err){ console.error('Submit error:', err); alert('Network error. Is backend running?'); }
      });
    })();
  </script>
  <!-- Signout handler to support new header -->
  <script>
    (function(){
      var btn = document.getElementById('signout');
      if (btn) {
        btn.addEventListener('click', function(){
          try { localStorage.removeItem('token'); localStorage.removeItem('role'); localStorage.removeItem('user'); } catch(_){ }
          window.open('signin.html', '_blank');
        });
      }
    })();
  </script>
  <script>
    (function(){
      try {
        var role = (localStorage.getItem('role') || localStorage.getItem('userRole') || '').toLowerCase();
        if (!role || (role !== 'buyer' && role !== 'seller')) return;
        var signInEl = document.querySelector('[data-text="sign-in"]');
        var signUpEl = document.querySelector('[data-text="sign-up"]');
        var container = (signInEl && signInEl.parentElement) || (signUpEl && signUpEl.parentElement);
        if (!container) return;
        if (signInEl) signInEl.remove();
        if (signUpEl) signUpEl.remove();
        var link = document.createElement('a');
        link.textContent = role === 'buyer' ? 'Buyer Dashboard' : 'Seller Dashboard';
        link.href = role === 'buyer' ? 'buyer-dashboard.html' : 'seller-dashboard.html';
        link.className = 'bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition-all transform hover:scale-105';
        container.appendChild(link);
      } catch(e) {}
    })();
  </script>
</body>
</html>
